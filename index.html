<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orario Docenti, Classi e Aule</title>
  <style>
    /* --- STILI INVARIATI --- */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    .header {
      background: linear-gradient(135deg, #2196F3, #21CBF3);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .mode-selector {
      text-align: center;
      background: rgba(247, 249, 252, 0.8);
      padding: 20px;
      border-bottom: 2px solid #e1e8ed;
    }
    .mode-buttons {
      display: inline-flex;
      gap: 10px;
      background: white;
      padding: 5px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .mode-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 50px;
      background: transparent;
      color: #666;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, #2196F3, #21CBF3);
      color: white;
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    .search-section {
      text-align: center;
      background: rgba(247, 249, 252, 0.8);
      padding: 30px;
    }
    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      position: relative;
    }
    .search-input {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid #e1e8ed;
      border-radius: 50px;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .search-input:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 8px 25px rgba(33,150,243,0.2);
    }
    .search-btn {
      background: linear-gradient(135deg, #2196F3, #21CBF3);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(33,150,243,0.3);
      transition: transform 0.2s ease;
    }
    .search-btn:hover { transform: scale(1.05); }

    #suggestionsList {
      position: absolute;
      top: 110%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      list-style: none;
      margin: 0;
      padding: 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: none;
      z-index: 10;
    }
    #suggestionsList li {
      padding: 10px 15px;
      cursor: pointer;
    }
    #suggestionsList li:hover {
      background: #f0f7ff;
    }

    .schedule-container { display: none; padding: 30px; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    .schedule-table { min-width: 700px; }

    .info-box {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 15px;
    }
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      border-radius: 15px;
      overflow: hidden;
    }
    .schedule-table th {
      background: linear-gradient(135deg, #2196F3, #21CBF3);
      color: white;
      padding: 18px 10px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
    }
    .schedule-table td {
      border: 1px solid #e8f4f8;
      text-align: center;
      padding: 14px 8px;
      font-size: 13px;
      background: white;
    }
    .schedule-table th:first-child {
      background: linear-gradient(135deg, #FF6B9D, #FFA07A);
    }
    .schedule-table td:first-child {
      background: linear-gradient(135deg, #FF6B9D, #FFA07A);
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    .lesson-info {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 8px;
      background: linear-gradient(135deg, #E3F2FD, #F0F7FF);
      line-height: 1.6;
      min-height: 45px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 3px;
    }
    .subject { font-weight: 700; color: #1976D2; font-size: 13px; }
    .teacher { font-weight: 700; color: #E91E63; font-size: 11px; }
    .room { font-weight: 700; color: #4CAF50; font-size: 11px; }
    /* --- STILE PULSANTI "Trova" e "Trova Ora" --- */
.find-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 28px;
  border: none;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  color: white;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
.find-btn:focus {
  outline: none;
}
.find-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* Variante verde */
.find-btn.green {
  background: linear-gradient(135deg, #4CAF50, #81C784);
}

/* Variante blu */
.find-btn.blue {
  background: linear-gradient(135deg, #2196F3, #21CBF3);
}

  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Orario Scolastico</h1>
      <p>Visualizza l'orario settimanale per docenti, classi o aule</p>
    </div>

    <div class="mode-selector">
      <div class="mode-buttons">
        <button class="mode-btn active" data-mode="teacher">üë®‚Äçüè´ Docenti</button>
        <button class="mode-btn" data-mode="class">üéì Classi</button>
        <button class="mode-btn" data-mode="room">üè´ Aule</button> <!-- ‚úÖ NUOVA MODALIT√Ä -->
      </div>
    </div>

    <div class="search-section">
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Inserisci il cognome del docente...">
        <button id="searchBtn" class="search-btn">üîç</button>
        <ul id="suggestionsList"></ul>
      </div>
      <!-- üè´ Sezione Trova Aula Vuota -->
<div id="findFreeRoomSection" style="display:none; text-align:center; padding:25px; background:rgba(247, 249, 252, 0.8); border-top:2px solid #e1e8ed;">

  <h3 style="margin-bottom:15px; color:#333;">üîç Trova Aula Vuota</h3>

  <div style="display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:10px;">

    <select id="daySelect" class="search-input" style="max-width:160px; border-radius:10px; padding:10px;">
      <option value="">Giorno</option>
      <option value="1">Luned√¨</option>
      <option value="2">Marted√¨</option>
      <option value="3">Mercoled√¨</option>
      <option value="4">Gioved√¨</option>
      <option value="5">Venerd√¨</option>
    </select>

    <select id="hourSelect" class="search-input" style="max-width:160px; border-radius:10px; padding:10px;">
      <option value="">Ora</option>
      <option value="1">1¬™ Ora</option>
      <option value="2">2¬™ Ora</option>
      <option value="3">3¬™ Ora</option>
      <option value="4">4¬™ Ora</option>
      <option value="5">5¬™ Ora</option>
      <option value="6">6¬™ Ora</option>
    </select>

<button id="searchFreeRoomBtn" type="button" class="find-btn green">
      üîç Trova
    </button>

<button id="findNowBtn" type="button" class="find-btn blue">
      ‚è∞ Aule Vuote Ora
    </button>
  </div>

  <div id="freeRoomsResult" style="margin-top:20px;"></div>
</div>

    </div>

    <div id="scheduleContainer" class="schedule-container">
      <div id="infoBox" class="info-box"></div>
      <div id="scheduleContent"></div>
    </div>
  </div>

  <script>
    let teachersData = {};
    let classesData = {};
    let roomsData = {}; // ‚úÖ NUOVO
    let currentMode = "teacher";

    async function loadData() {
      try {
        const ts = new Date().getTime();
        const [tResp, cResp, rResp] = await Promise.all([
          fetch(`doc_dict.json?nocache=${ts}`),
          fetch(`class_dict.json?nocache=${ts}`),
          fetch(`aule_dict.json?nocache=${ts}`) // ‚úÖ NUOVO FILE
        ]);
        teachersData = await tResp.json();
        classesData = await cResp.json();
        roomsData = await rResp.json();
        console.log(roomsData);
        console.log("Dati caricati ‚úÖ");
        updateSuggestions();

      } catch (err) {
        console.error("Errore nel caricamento:", err);
        alert("Errore nel caricamento dei JSON (usa Live Server o http://localhost)");
      }
    }
    function getCurrentSchoolSlotInfo(timestamp) {
  const giorni = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨"];
  const orari = [
    "8:10‚Äì9:10",
    "9:10‚Äì10:10",
    "10:10‚Äì11:00",
    "11:20‚Äì12:10",
    "12:10‚Äì13:05",
    "13:05‚Äì14:00"
  ];
  const slots = [
    [490, 550],  // 1¬™ ora
    [550, 610],  // 2¬™ ora
    [610, 660],  // 3¬™ ora
    [680, 730],  // 4¬™ ora
    [730, 785],  // 5¬™ ora
    [785, 840]   // 6¬™ ora
  ];

  const d = new Date(timestamp);
  const jsDay = d.getDay(); // 0 = Domenica, 1 = Luned√¨, ..., 6 = Sabato

  // ‚ö†Ô∏è Weekend -> errore
  if (jsDay === 0 || jsDay === 6) {
    throw new Error("Fuori range: oggi √® weekend (Sabato o Domenica).");
  }

  const day = jsDay; // 1..5
  const minutes = d.getHours() * 60 + d.getMinutes();

  // ‚ö†Ô∏è Fuori orario scolastico
  if (minutes < slots[0][0] || minutes >= slots[slots.length - 1][1]) {
    throw new Error("Fuori range: orario al di fuori dell‚Äôorario scolastico (prima delle 8:10 o dopo le 14:00).");
  }

  let hour = null;
  for (let i = 0; i < slots.length; i++) {
    const [start, end] = slots[i];
    if (minutes >= start && minutes < end) {
      hour = i + 1; // 1..6
      break;
    }
  }

  if (!hour) {
    throw new Error("Fuori range: non sei all‚Äôinterno di una lezione (es. pausa tra le ore).");
  }

  // Calcola indice complessivo
  const index = (day - 1) * 6 + hour;

  // Crea stringa descrittiva
  const label = `${giorni[day - 1]} - ${hour}¬™ ora (${orari[hour - 1]})`;

  return {
    index,  // numero intero (1..30)
    day,    // giorno 1..5
    hour,   // ora 1..6
    label   // stringa descrittiva
  };
}

/**
 * Restituisce tutte le chiavi del dizionario (aule)
 * che hanno una stringa vuota o "Disp" nella posizione i.
 *
 * @param {Object} data - Dizionario delle aule (come roomsData)
 * @param {number} i - Indice (0-based)
 * @returns {string[]} - Lista delle aule vuote a quell‚Äôindice
 */
function findEmptyRoomsAtIndex(data, i) {
  if (typeof i !== "number" || i < 0) {
    throw new Error("L'indice deve essere un numero intero non negativo.");
  }

  const result = [];

  for (const [room, schedule] of Object.entries(data)) {
    const cell = schedule[i];

    // Consideriamo vuota se √® stringa vuota, null, undefined o "disp" (case-insensitive)
    if (!cell || cell.trim() === "" || cell.toLowerCase().includes("disp")) {
      result.push(room);
    }
  }

  return result;
}

try {
  const slot = getCurrentSchoolSlotInfo(Date.now());
  const freeRooms = findEmptyRoomsAtIndex(roomsData, slot.index - 1); // -1 se i tuoi array sono 0-based
  console.log(`Aule libere ora (${slot.label}):`, freeRooms);
} catch (err) {
  console.error(err.message);
}

function getCurrentSchoolIndex(timestamp) {
  const slots = [
    [490, 550],  // 1¬™ ora: 8:10‚Äì9:10
    [550, 610],  // 2¬™ ora: 9:10‚Äì10:10
    [610, 660],  // 3¬™ ora: 10:10‚Äì11:00
    [680, 730],  // 4¬™ ora: 11:20‚Äì12:10
    [730, 785],  // 5¬™ ora: 12:10‚Äì13:05
    [785, 840]   // 6¬™ ora: 13:05‚Äì14:00
  ];

  const d = new Date(timestamp);
  const jsDay = d.getDay(); // 0 = Dom, 1 = Lun, ..., 6 = Sab

  if (jsDay === 0 || jsDay === 6) {
    throw new Error("Fuori range: oggi √® weekend (Sabato/Domenica).");
  }

  const day = jsDay; // Lun=1 ... Ven=5
  const minutes = d.getHours() * 60 + d.getMinutes();

  if (minutes < slots[0][0] || minutes >= slots[slots.length - 1][1]) {
    throw new Error("Fuori range: ora al di fuori dell'orario scolastico (prima delle 8:10 o dopo le 14:00).");
  }

  let hour = null;
  for (let i = 0; i < slots.length; i++) {
    const [start, end] = slots[i];
    if (minutes >= start && minutes < end) {
      hour = i + 1; // 1..6
      break;
    }
  }

  if (!hour) {
    throw new Error("Fuori range: non sei all'interno di una lezione (es. pausa).");
  }

  // restituisco indice (1..30)
  return (day - 1) * 6 + hour;
}


    function updateSuggestions() {
      let data;
      if (currentMode === "teacher") data = teachersData;
      else if (currentMode === "class") data = classesData;
      else data = roomsData; // ‚úÖ GESTIONE AULE

      const list = document.getElementById("suggestionsList");
      list.innerHTML = "";

      Object.keys(data)
        .sort((a, b) => a.localeCompare(b))
        .forEach(k => {
          const li = document.createElement("li");
          li.textContent = k;
          li.addEventListener("click", () => {
            document.getElementById("searchInput").value = k;
            list.style.display = "none";
            searchSchedule(k);
          });
          list.appendChild(li);
        });
    }

    const input = document.getElementById("searchInput");
    const suggestionsList = document.getElementById("suggestionsList");

    input.addEventListener("input", () => {
      const val = input.value.toLowerCase();
      const items = suggestionsList.querySelectorAll("li");
      let visibleCount = 0;

      items.forEach(li => {
        if (li.textContent.toLowerCase().includes(val)) {
          li.style.display = "block";
          visibleCount++;
        } else {
          li.style.display = "none";
        }
      });

      suggestionsList.style.display = visibleCount > 0 ? "block" : "none";
    });

    document.addEventListener("click", e => {
      if (!e.target.closest("#searchInput") && !e.target.closest("#suggestionsList")) {
        suggestionsList.style.display = "none";
      }
    });

    function formatCell(cellText, mode) {
      if (!cellText || cellText.trim() === "") return "";
      cellText = cellText.replace(/\\n/g, ' ');

      if (cellText.toLowerCase().includes("disp")) {
        return `<div class="lesson-info"><span style="color: #999; font-style: italic;">${cellText}</span></div>`;
      }

      if (mode === "class") {
        const match = cellText.match(/^(.+?)\s*\(([^)]+)\)\s*\(([^)]+)\)\s*$/);
        if (match) {
          const subject = match[1].trim();
          const teacher = match[2].trim();
          const room = match[3].trim();
          return `<div class="lesson-info">
                    <span class="subject">${subject}</span>
                    <span class="teacher">${teacher}</span>
                    <span class="room">${room}</span>
                  </div>`;
        }
      } 
      else if (mode === "teacher") {
        const match = cellText.match(/^(.+?)\s*\(([^)]+)\)\s*$/);
        if (match) {
          const classInfo = match[1].trim();
          const room = match[2].trim();
          return `<div class="lesson-info">
                    <span class="subject">${classInfo}</span>
                    <span class="room">${room}</span>
                  </div>`;
        } else {
          return `<div class="lesson-info"><span class="subject">${cellText.trim()}</span></div>`;
        }
      } 
      else if (mode === "room") { // ‚úÖ FORMATTAZIONE PER LE AULE
        const match = cellText.match(/^(.+?)\s*\(([^)]+)\)\s*\(([^)]+)\)\s*$/);
        if (match) {
          const subject = match[1].trim();
          const teacher = match[2].trim();
          const className = match[3].trim();
          return `<div class="lesson-info">
                    <span class="subject">${subject}</span>
                    <span class="teacher">${teacher}</span>
                    <span class="room">${className}</span>
                  </div>`;
        }
      }

      return `<div class="lesson-info"><span class="subject">${cellText}</span></div>`;
    }

    function setupSearchListeners() {
  const input = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');

  // Rimuovi eventuali listener vecchi
  searchBtn.replaceWith(searchBtn.cloneNode(true));
  input.replaceWith(input.cloneNode(true));

  // Ricollega gli elementi
  const newInput = document.getElementById('searchInput');
  const newSearchBtn = document.getElementById('searchBtn');

  newSearchBtn.addEventListener('click', () => {
     console.log("click")
    const name = newInput.value.trim();
    if (name) searchSchedule(name);
  });

  newInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const name = e.target.value.trim();
      if (name) searchSchedule(name);
    }
  });
}

    
    function searchSchedule(name) {
      // üßπ Pulisce la sezione Trova Aula Vuota se visibile
const freeRoomsResult = document.getElementById("freeRoomsResult");
if (freeRoomsResult) freeRoomsResult.innerHTML = "";

      let data;
      if (currentMode === "teacher") data = teachersData;
      else if (currentMode === "class") data = classesData;
      else data = roomsData; // ‚úÖ NUOVO CASO

      const keys = Object.keys(data);
      const key = keys.find(k => k.toLowerCase().includes(name.toLowerCase()));
      const result = key ? data[key] : null;

      const container = document.getElementById("scheduleContainer");
      const infoBox = document.getElementById("infoBox");
      const scheduleContent = document.getElementById("scheduleContent");

      if (!result) {
        infoBox.innerHTML = `<h2>Nessun risultato trovato</h2>`;
        scheduleContent.innerHTML = "";
        container.style.display = "block";
        return;
      }

      let label = "Orario del docente";
      if (currentMode === "class") label = "Orario della classe";
      if (currentMode === "room") label = "Orario dell‚Äôaula";

      infoBox.innerHTML = `<h2>${key}</h2><p>${label}</p>`;

      const giorni = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨"];
      let html = `<div class="table-wrapper"><table class="schedule-table"><thead><tr><th>Ora</th>`;
      giorni.forEach(g => html += `<th>${g}</th>`);
      html += `</tr></thead><tbody>`;

        const orari = [
          "8:10‚Äì9:10",
          "9:10‚Äì10:10",
          "10:10‚Äì11:00",
          "11:20‚Äì12:10",
          "12:10‚Äì13:05",
          "13:05‚Äì14:00"
        ];


      for (let ora = 0; ora < 6; ora++) {
        // Stampa numero ora e orario corrispondente
         html += `<tr><td><strong>${ora + 1}</strong><br><span style="font-size:14px; color:#555;">${orari[ora]}</span></td>`;
        for (let giorno = 0; giorno < giorni.length; giorno++) {
          const idx = giorno * 6 + ora;
          const cell = result[idx] || "";
          const formattedCell = formatCell(cell, currentMode);
          html += `<td>${formattedCell}</td>`;
        }
        html += `</tr>`;
      }

      html += `</tbody></table></div>`;
      scheduleContent.innerHTML = html;
      container.style.display = "block";
    }

    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;

        const searchInput = document.getElementById('searchInput');
        const suggestionsList = document.getElementById('suggestionsList');
        const scheduleContainer = document.getElementById("scheduleContainer");

        searchInput.value = "";
        suggestionsList.style.display = "none";
        suggestionsList.innerHTML = "";
        scheduleContainer.style.display = "none";
        document.getElementById("scheduleContent").innerHTML = "";

        searchInput.placeholder = 
          currentMode === "teacher" ? "Inserisci il cognome del docente..." :
          currentMode === "class"   ? "Inserisci la classe (es. 3A)..." :
                                      "Inserisci il nome dell‚Äôaula..."; // ‚úÖ NUOVO PLACEHOLDER

        updateSuggestions();
        

      });
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      console.log(currentMode)
      const name = document.getElementById('searchInput').value.trim();
      if (name) searchSchedule(name);
    });

    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const name = e.target.value.trim();
        if (name) searchSchedule(name);
      }
    });

    loadData();

    // === üè´ TROVA AULA VUOTA ===

// Mostra la sezione solo in modalit√† "Aule"
function toggleFindFreeRoomSection() {
  document.getElementById("findFreeRoomSection").style.display = 
    currentMode === "room" ? "block" : "none";
}
toggleFindFreeRoomSection();

// Quando si cambia modalit√†, aggiorna visibilit√†
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    toggleFindFreeRoomSection();
  });
});

// Funzione per cercare aule vuote in base a giorno/ora scelti
document.getElementById("searchFreeRoomBtn").addEventListener("click", () => {
  event.preventDefault();
  const day = parseInt(document.getElementById("daySelect").value);
  const hour = parseInt(document.getElementById("hourSelect").value);
  const resultBox = document.getElementById("freeRoomsResult");
  resultBox.innerHTML = "";

  if (!day || !hour) {
    alert("Seleziona giorno e ora!");
    return;
  }

  const index = (day - 1) * 6 + hour; // stesso calcolo del tuo orario
  const freeRooms = findEmptyRoomsAtIndex(roomsData, index - 1);

  if (freeRooms.length === 0) {
    resultBox.innerHTML = `
      <div class="info-box" style="background:linear-gradient(135deg,#FF6B9D,#FFA07A);">
        <strong>Nessuna aula libera in questa fascia oraria.</strong>
      </div>`;
  } else {
        document.getElementById("scheduleContainer").style.display = "none";


    resultBox.innerHTML = `
      <div class="info-box" style="background:linear-gradient(135deg,#4CAF50,#81C784);">
        <h3>Aule libere:</h3>
        <p>${freeRooms.join(", ")}</p>
      </div>`;
      

  }
});

// üîÑ Bottone "Trova Ora" ‚Äî usa la funzione getCurrentSchoolIndex()
document.getElementById("findNowBtn").addEventListener("click", () => {
  const resultBox = document.getElementById("freeRoomsResult");
  resultBox.innerHTML = "";
  event.preventDefault();


  try {
    const slot = getCurrentSchoolSlotInfo(Date.now());
    const freeRooms = findEmptyRoomsAtIndex(roomsData, slot.index - 1);

    if (freeRooms.length === 0) {
      resultBox.innerHTML = `
        <div class="info-box" style="background:linear-gradient(135deg,#FF6B9D,#FFA07A);">
          <strong>Nessuna aula libera in questo momento.</strong>
        </div>`;
    } else {
      resultBox.innerHTML = `
        <div class="info-box" style="background:linear-gradient(135deg,#4CAF50,#81C784);">
          <h3>Aule libere ora:</h3>
          <p>${slot.label}</p>
          <p><strong>${freeRooms.join(", ")}</strong></p>
        </div>`;
    }
    

  } catch (err) {
    alert(err.message);
    
  }
});

  </script>
</body>
</html>
